<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PENGURUSAN RMT SKIOR 2026</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .canvas-header { background-color: #002d5b; border-bottom: 5px solid #ff7a00; }
        .student-card { transition: all 0.2s ease; cursor: pointer; }
        .student-card:active { transform: scale(0.97); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyAiwLcVI-EMmP9nRIpA6IXgPICbHyrXwVE",
            authDomain: "rmt-digital-8df83.firebaseapp.com",
            projectId: "rmt-digital-8df83",
            storageBucket: "rmt-digital-8df83.firebasestorage.app",
            messagingSenderId: "161720627010",
            appId: "1:161720627010:web:84b4da0da31ea8ca8ca2db"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const App = () => {
            const [view, setView] = useState('attendance');
            const [activeClass, setActiveClass] = useState('PPKI');
            const [presentToday, setPresentToday] = useState([]);
            const [monthlyStats, setMonthlyStats] = useState({});
            const [searchTerm, setSearchTerm] = useState('');
            const time = new Date();

            const classes = ['PPKI', '1 AFQ', '1 AFT', '1 ANR', '1 ARR', '2 AFQ', '2 AFT', '2 ANR', '2 ARR', '3 AFQ', '3 AFT', '3 ANR', '3 ARR', '4 AFQ', '4 AFT', '4 ANR', '4 ARR', '5 AFQ', '5 AFT', '5 ANR', '5 ARR', '6 AFQ', '6 AFT', '6 ANR', '6 ARR'];
            
            const rawStudents = [
                { name: "KHADEEJA AFEEYA BINTI ISMAIL", class: "PPKI" },
                { name: "MUHAMMAD AMMAR FARISH BIN MOHD EMRY", class: "PPKI" },
                { name: "WAN SHAFIY BENJAMIN BIN WAN MOHD HAFIZULLAH", class: "PPKI" },
                { name: "AHMAD ZIYAD AMZAR BIN ZAMRI", class: "PPKI" },
                { name: "CHE NOR ASHIF BIN CHE MAT SOKRI", class: "PPKI" },
                { name: "ISKANDAR ZAMAKHSHARY BIN ISKANDAR ZULKARNAIN", class: "PPKI" },
                { name: "MUHAMMAD ADAM TAUFIQILLAH BIN MOHD FAIZAL", class: "PPKI" },
                { name: "MUHAMMAD AQEEL NAUFAL BIN MOHD AZELAN", class: "PPKI" },
                { name: "MUHAMMAD FIRAS DANISH BIN ABDUL HALIM", class: "PPKI" },
                { name: "MUHAMMAD IFFAT NAFIS BIN MOHD IKHWAN NAIM", class: "PPKI" },
                { name: "NUR ADZRAA QAIREENA BINTI AHMAD ZAKRI", class: "PPKI" },
                { name: "UFAIRA NUR AFIFA BINTI MOHD HAFIZAN", class: "PPKI" },
                { name: "ARWA BINTI ABDUL WAHAB", class: "PPKI" },
                { name: "MUHAMAD RAZIQ BIN SOBRI SALAEH", class: "PPKI" },
                { name: "MUHAMMAD AQIL ZIQRI BIN JUNAIDI", class: "PPKI" },
                { name: "NUR ASMA IMANI BINTI ABDULLAH", class: "PPKI" },
                { name: "NUR HAZIRAHUDA BINTI GHAZALI", class: "PPKI" },
                { name: "NUR IMAN BINTI AHMAD ZAMURI", class: "PPKI" },
                { name: "ADNIN AMIRAH IRDINA BINTI ZAMRI", class: "PPKI" },
                { name: "AHMAD MUIZZUDDIN QAWIEM BIN AHMAD MUSABAQAH", class: "PPKI" },
                { name: "AQIL HAZIQ BIN AMIR IBRAHIM", class: "PPKI" },
                { name: "MUHAMAD IZZ IRFAN BIN KAMARUL ARIFIN", class: "PPKI" },
                { name: "MUHAMAD RIZQIE DARWISH BIN ABDUL RAHMAN", class: "PPKI" },
                { name: "MUHAMMAD AMMAR BIN KOSSIM", class: "PPKI" },
                { name: "MUHAMMAD AQIF IMAN BIN MOHD", class: "PPKI" },
                { name: "MUHAMMAD AQIFF HAIKAL BIN SIDI AHMAD", class: "PPKI" },
                { name: "MUHAMMAD FIRASH AKRAM BIN AZHAR", class: "PPKI" },
                { name: "MUHAMMAD MIKAIL DANISH BIN ABDUL HALIM", class: "PPKI" },
                { name: "MUHAMMAD MIKAIL ISRAFIL BIN OSMAN", class: "PPKI" },
                { name: "NUR AFIFAH ZAHIDAH BINTI ZAILANI", class: "PPKI" },
                { name: "NUR QAIREEN QAISARA BINTI MUHAMMAD", class: "PPKI" },
                { name: "PUTRA RAYYAN MIKAIL BIN NOR RAJU", class: "PPKI" },
                { name: "RIZQI ASHRAF BIN IZMEER", class: "PPKI" },
                { name: "NUR ARFA NADRAH BINTI MOHD DASUKI", class: "6 AFT" },
                { name: "WAN NUR IRDINA ZULAIKHA BINTI MOHD HAIKAL", class: "6 AFT" },
                { name: "AR RAYYAN FAWWAZ BIN AIDIL PUTRA", class: "6 AFQ" },
                { name: "CHE WAN NUR AINA ZAFIRAH BINTI CHE WAN ZULKIFLI", class: "6 AFQ" },
                { name: "MUHAMMAD AMMAR BIN AHMAD JAMARI", class: "6 AFQ" },
                { name: "NUR DAYANA TIHANIE BINTI AHMAD", class: "6 AFQ" },
                { name: "NUR DINI ZAHRAA BINTI HANAFFI", class: "6 AFQ" },
                { name: "NUR SYARAH IZZATI BINTI MOHD FADZLI", class: "6 AFQ" },
                { name: "NURIN QASRINA BINTI ZULFAHMI", class: "6 AFQ" },
                { name: "SYAFIYAH BASHIRAH BINTI AHMAD NIZAM", class: "6 AFQ" },
                { name: "THAQIF NASRULLAH BIN ZAKARIA", class: "6 AFQ" },
                { name: "FATIN NOR HAYATI BINTI OTHMAN", class: "6 ANR" },
                { name: "MUHAMMAD AMMAR RIZQI BIN MOHD NASRULLAH", class: "6 ANR" },
                { name: "MUHAMMAD FAJAR BIN MOHD ZAINAL", class: "6 ANR" },
                { name: "MUHAMMAD NOR HAQIF BIN MOHD NOOR", class: "6 ANR" },
                { name: "NUR AINA BINTI MAZLAN", class: "6 ANR" },
                { name: "NUR ASSYIFA' FATIHAH BINTI AB KARIM", class: "6 ANR" },
                { name: "ROSE AIN AQILLA BINTI ALANG ISKANDAR", class: "6 ANR" },
                { name: "ROSE QIERANA MUSTIQA BINTI NOR AZMI", class: "6 ANR" },
                { name: "ARIANA DAMIA BINTI IMRAN", class: "6 ARR" },
                { name: "ASHRAFF MUSTAQIM BIN AFENDI", class: "6 ARR" },
                { name: "CHE KU IBRAHIM BIN CHEKU SULAIMAN", class: "6 ARR" },
                { name: "MUHAMMAD AMSYAR ZAHIN BIN MOHD ZULADERA", class: "6 ARR" },
                { name: "MUHAMMAD ARASH MURSYI BIN HARDY YASSIN", class: "6 ARR" },
                { name: "MUHAMMAD ARASH MUZKYI BIN HARDY YASSIN", class: "6 ARR" },
                { name: "MUHAMMAD NAZHAN DANISH BIN MOHD NIZRUL IDLAN", class: "6 ARR" },
                { name: "MUHAMMAD NUR NAZMIRULLAH BIN MOHD RAFFI", class: "6 ARR" },
                { name: "MUHAMMAD QAADIRAN NASRULLAH BIN KAMARULZAMAN", class: "6 ARR" },
                { name: "MUHAMMAD QAUSAR FIQRI BIN MOHAMAD", class: "6 ARR" },
                { name: "NUR AIERIS ILYANA BINTI NORAZMAN", class: "6 ARR" },
                { name: "NUR AIMY SAFIYYA BINTI AHMAD FAIZAL", class: "6 ARR" },
                { name: "NUR NAJWA AMNA BINTI RASID", class: "6 ARR" }
            ];

            const studentsWithIds = useMemo(() => 
                rawStudents.map(s => ({ ...s, id: s.name.replace(/\s+/g, '_').toLowerCase() }))
            , []);

            // 1. Fetch Today's Attendance
            useEffect(() => {
                const today = new Date().toISOString().split('T')[0];
                const unsub = db.collection('daily_attendance').doc(today)
                    .onSnapshot(doc => {
                        if (doc.exists) setPresentToday(doc.data().students || []);
                        else setPresentToday([]);
                    });
                return () => unsub();
            }, []);

            // 2. Fetch Monthly Stats for Summary
            useEffect(() => {
                if (view === 'summary') {
                    const currentMonth = new Date().toISOString().substring(0, 7); // "2026-01"
                    db.collection('daily_attendance')
                        .where(firebase.firestore.FieldPath.documentId(), '>=', `${currentMonth}-01`)
                        .where(firebase.firestore.FieldPath.documentId(), '<=', `${currentMonth}-31`)
                        .get()
                        .then(snapshot => {
                            const counts = {};
                            snapshot.forEach(doc => {
                                const students = doc.data().students || [];
                                students.forEach(id => {
                                    counts[id] = (counts[id] || 0) + 1;
                                });
                            });
                            setMonthlyStats(counts);
                        });
                }
            }, [view]);

            const toggleAttendance = async (studentId) => {
                const today = new Date().toISOString().split('T')[0];
                const docRef = db.collection('daily_attendance').doc(today);
                const isPresent = presentToday.includes(studentId);
                try {
                    await docRef.set({
                        students: isPresent 
                            ? firebase.firestore.FieldValue.arrayRemove(studentId)
                            : firebase.firestore.FieldValue.arrayUnion(studentId),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (err) { console.error(err); }
            };

            const filteredStudents = useMemo(() => {
                return studentsWithIds.filter(s => 
                    s.class === activeClass && 
                    s.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [activeClass, studentsWithIds, searchTerm]);

            return (
                <div className="min-h-screen pb-20">
                    <header className="canvas-header text-white p-6 shadow-xl no-print">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3">
                                <div className="bg-white p-2 rounded-xl text-2xl">ü•£</div>
                                <div>
                                    <h1 className="text-xl font-extrabold uppercase tracking-tight leading-none">PENGURUSAN RMT SKIOR</h1>
                                    <p className="text-[10px] font-bold text-orange-400 uppercase tracking-widest mt-1">Sistem Digital 2026</p>
                                </div>
                            </div>
                            <div className="text-center font-bold">
                                <p className="text-[10px] opacity-60 uppercase tracking-widest">Tarikh Hari Ini</p>
                                <p className="text-lg">{time.toLocaleDateString('en-MY', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 mt-8">
                        {/* Tab Switcher */}
                        <div className="flex bg-gray-200/50 p-1 rounded-2xl mb-8 no-print max-w-md mx-auto">
                            <button onClick={() => setView('attendance')} className={`flex-1 py-3 rounded-xl font-black text-[10px] transition-all ${view==='attendance'?'bg-[#002d5b] text-white shadow-md':'text-gray-500'}`}>TANDA HADIR</button>
                            <button onClick={() => setView('summary')} className={`flex-1 py-3 rounded-xl font-black text-[10px] transition-all ${view==='summary'?'bg-[#002d5b] text-white shadow-md':'text-gray-500'}`}>RUMUSAN BULANAN</button>
                        </div>

                        {/* Class Selector - FIXED GRID VIEW */}
                        <div className="no-print mb-8">
                            <p className="text-[10px] font-black text-gray-400 uppercase mb-3 text-center tracking-widest">Pilih Kelas</p>
                            <div className="flex flex-wrap justify-center gap-2">
                                {classes.map(c => (
                                    <button 
                                        key={c} 
                                        onClick={() => {setActiveClass(c); setSearchTerm('');}} 
                                        className={`px-4 py-2 rounded-lg text-[10px] font-bold transition-all border ${activeClass === c ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-500 border-gray-100'}`}
                                    >
                                        {c}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {view === 'attendance' ? (
                            <div className="no-print">
                                <div className="mb-6">
                                    <input type="text" placeholder="Cari nama murid..." className="w-full p-4 rounded-2xl border border-gray-100 shadow-sm text-sm font-bold focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    {filteredStudents.map((s, idx) => {
                                        const isPresent = presentToday.includes(s.id);
                                        return (
                                            <div key={s.id} onClick={() => toggleAttendance(s.id)} className={`student-card p-4 rounded-2xl border-2 flex items-center justify-between ${isPresent ? 'bg-blue-50 border-blue-500 shadow-md' : 'bg-white border-transparent shadow-sm'}`}>
                                                <div className="flex items-center gap-3">
                                                    <span className="text-[10px] font-bold text-gray-300 w-5">{idx + 1}</span>
                                                    <p className={`text-xs font-extrabold uppercase leading-tight ${isPresent ? 'text-blue-900' : 'text-gray-700'}`}>{s.name}</p>
                                                </div>
                                                <div className={`shrink-0 w-6 h-6 rounded-full flex items-center justify-center transition-all ${isPresent ? 'bg-blue-600 text-white' : 'bg-gray-100 text-transparent'}`}>‚úì</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : (
                            /* RUMUSAN BULANAN VIEW */
                            <div className="bg-white rounded-3xl p-8 shadow-sm border border-gray-100">
                                <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                                    <div className="text-center md:text-left">
                                        <h2 className="text-xl font-black text-[#002d5b] uppercase">Rumusan Kehadiran Bulanan</h2>
                                        <p className="text-xs text-gray-400 font-bold uppercase tracking-widest">KELAS: {activeClass} | BULAN: {new Intl.DateTimeFormat('ms-MY', { month: 'long', year: 'numeric' }).format(time)}</p>
                                    </div>
                                    <button onClick={() => window.print()} className="no-print px-6 py-3 bg-black text-white rounded-xl text-[10px] font-black hover:opacity-80 transition-all shadow-lg">üñ®Ô∏è CETAK LAPORAN</button>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead>
                                            <tr className="border-b-2 border-gray-50 text-[10px] font-black text-gray-400 uppercase">
                                                <th className="py-4 px-2">Bil</th>
                                                <th className="py-4 px-2">Nama Murid</th>
                                                <th className="py-4 px-2 text-center">Jumlah Hari Hadir (Bulan Ini)</th>
                                                <th className="py-4 px-2 text-right">Status Hari Ini</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredStudents.map((s, idx) => (
                                                <tr key={s.id} className="border-b border-gray-50 hover:bg-gray-50">
                                                    <td className="py-4 px-2 text-xs font-bold text-gray-300">{idx + 1}</td>
                                                    <td className="py-4 px-2 text-xs font-black text-[#002d5b] uppercase">{s.name}</td>
                                                    <td className="py-4 px-2 text-center">
                                                        <span className="bg-blue-600 text-white px-4 py-1 rounded-lg text-xs font-black">
                                                            {monthlyStats[s.id] || 0} HARI
                                                        </span>
                                                    </td>
                                                    <td className="py-4 px-2 text-right">
                                                        {presentToday.includes(s.id) ? 
                                                            <span className="text-green-500 font-bold text-[10px]">HADIR HARI INI</span> : 
                                                            <span className="text-red-400 font-bold text-[10px]">TIADA</span>
                                                        }
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mt-8 pt-8 border-t border-dashed border-gray-200 text-center text-[10px] font-bold text-gray-400 uppercase">
                                    Laporan ini dijana secara automatik oleh Sistem RMT Digital SKIOR 2026
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
